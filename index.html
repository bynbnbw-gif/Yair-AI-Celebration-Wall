<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¡×™×‘×ª ×”×‘×¨×›×•×ª ×©×œ ×™××™×¨ - ×‘×¨ ××¦×•×•×”/×™×•× ×”×•×œ×“×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap');
        body {
            font-family: 'Heebo', sans-serif;
            background-color: #f0f4f8; /* Soft blue-gray background */
            color: #1e293b;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #e2e8f0;
        }
        .tab-button {
            transition: all 0.3s ease;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            padding-bottom: 8px;
        }
        .tab-button.active {
            border-bottom-color: #f59e0b; /* Amber for celebration */
            color: #f59e0b;
            font-weight: 700;
        }
        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }
        .loading-ring {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .ai-output {
            white-space: pre-wrap;
            line-height: 1.6;
            text-align: right;
        }
        .greeting-item {
            border: 1px solid #cbd5e1;
            transition: transform 0.2s;
        }
        .greeting-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, arrayUnion, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL FIREBASE/AUTH SETUP ---
        // ×”-App ID ×™×›×•×œ ×œ×”×›×™×œ × ×ª×™×‘×™× ××™×•×ª×¨×™×. ×× ×• ×× ×§×™× ××•×ª×• ×•××™×™×¦×¨×™× App ID ×ª×§× ×™.
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        // ×§×•×“ ×—×“×© ×œ× ×™×§×•×™ ×”-App ID ×›×“×™ ×œ×”×‘×˜×™×— ×©×”×•× ×©× ××¡××š ×—×•×§×™:
        const appId = rawAppId.includes('_public') 
            ? rawAppId.substring(0, rawAppId.indexOf('_public')) 
            : rawAppId;
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Set Firebase logging level to debug for troubleshooting permission issues
        setLogLevel('debug'); 

        let db, auth, userId;
        let isAuthReady = false;
        let isListenerSetup = false; // Flag to ensure onSnapshot is called only once
        let initialSignInAttempted = false; // Flag to prevent repeated sign-in calls

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        
        // Helper function for Firestore path
        const getGreetingsCollectionRef = () => {
            // ×”× ×ª×™×‘ ×”× ×›×•×Ÿ ×—×™×™×‘ ×œ×”×™×•×ª: /artifacts/{APP_ID}/public/data/greetings (5 ×¤×œ×—×™×)
            return collection(db, 'artifacts', appId, 'public', 'data', 'greetings');
        };

        /**
         * Function to handle initial sign-in: Tries custom token, falls back to anonymous.
         */
        const initialSignIn = async () => {
            if (initialSignInAttempted) return;
            initialSignInAttempted = true;
            
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    return; // Wait for onAuthStateChanged to handle success
                } catch (error) {
                    console.warn("Custom token sign in failed, falling back to anonymous:", error);
                    // Fall through to anonymous sign-in
                }
            }

            try {
                await signInAnonymously(auth);
                // Wait for onAuthStateChanged to handle success
            } catch (error) {
                console.error("Anonymous sign in failed:", error);
                userId = crypto.randomUUID(); // Fallback ID for display
                isAuthReady = true;
            }
        }


        // 1. Authentication and Initialization Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = `××–×”×” ××©×ª××©: ${userId}`;
                console.log("Firebase initialized. User ID:", userId);

                // Start listening ONLY if it hasn't started yet and we have a user
                if (db && !isListenerSetup) {
                    setupGreetingListener();
                    isListenerSetup = true;
                }
            } else if (!auth.currentUser && !initialSignInAttempted) {
                // If the user is null and we haven't tried to sign in yet, start the process.
                 initialSignIn();
            }
            // If user is null and initialSignInAttempted is true, sign-in is pending/failed.
        });

        // Trigger the initial sign-in attempt
        initialSignIn();

        // --- AI API CALL HANDLERS ---
        
        /**
         * Retries a fetch request using exponential backoff.
         * @param {string} url - The URL to fetch.
         * @param {object} options - Fetch options.
         * @param {number} retries - Number of retries left.
         * @returns {Promise<Response>}
         */
        const fetchWithBackoff = async (url, options, retries = 5) => {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status !== 429 && response.ok) {
                        return response;
                    }
                    if (response.status === 429 && i < retries - 1) {
                         const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                         await new Promise(resolve => setTimeout(resolve, delay));
                         continue;
                    }
                    if (!response.ok) {
                         const errorBody = await response.text();
                         throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
                    }
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API call failed after multiple retries.");
        };

        /**
         * Generates text using Gemini model (for greetings).
         * @param {string} prompt - The user prompt.
         * @returns {Promise<string>} - The generated text.
         */
        window.generateAiGreeting = async (prompt) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // Updated system prompt for a more celebratory, Israeli context
            const systemPrompt = "××ª×” ××©×£ ×›×ª×™×‘×ª ×‘×¨×›×•×ª ××™×©×™×•×ª, ×—××•×ª ×•××¨×’×©×•×ª, ×‘××™×•×—×“ ×œ××™×¨×•×¢×™ ×‘×¨ ××¦×•×•×” ×•×™×•× ×”×•×œ×“×ª. ×›×ª×•×‘ ×‘×¨×›×” ×™×¦×™×¨×ª×™×ª, ×›× ×”, ×•××•×©×œ××ª ×œ××™×¨×•×¢ ×”××‘×•×§×©. ×¢× ×” ×¨×§ ×¢× × ×•×¡×— ×”×‘×¨×›×” ×¢×¦××•, ×œ×œ× ×”×§×“××•×ª ××• ×›×•×ª×¨×•×ª × ×•×¡×¤×•×ª.";
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                config: {
                    // Reduce verbosity
                    maxOutputTokens: 250
                }
            };
            
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "×©×’×™××”: ×œ× ×”×¦×œ×—×ª×™ ×œ×™×™×¦×¨ ×‘×¨×›×”. × ×¡×” ×©×•×‘.";
                return text;

            } catch (error) {
                console.error("Gemini API Error:", error);
                return `×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×‘×™× ×” ×”××œ××›×•×ª×™×ª: ${error.message}. × ×¡×” ×©×•×‘.`;
            }
        };

        /**
         * Generates song lyrics using Gemini model (for Yair).
         * @param {string} keywords - User provided keywords/memories.
         * @returns {Promise<string>} - The generated song lyrics.
         */
        window.generateAiSong = async (keywords) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "××ª×” ×¤×–××•× ××™ ×™×©×¨××œ×™ ××§×¦×•×¢×™ ×œ×©×™×¨×™ ××™×¨×•×¢×™×, ×‘××™×•×—×“ ×œ×‘×¨ ××¦×•×•×” ×•×™×•× ×”×•×œ×“×ª. ××©×™××ª×š ×”×™× ×œ×›×ª×•×‘ ×©×™×¨ ××™×©×™ ×•××¨×’×© ×œ×™××™×¨, ×ª×•×š ×©×™×œ×•×‘ ×©×œ ××™×œ×•×ª ×”××¤×ª×— ×©×”××©×ª××© ×¡×™×¤×§. ×”×©×™×¨ ×¦×¨×™×š ×œ×›×œ×•×œ 2-3 ×‘×ª×™×, ×¤×–××•×Ÿ (Chorus) ×•×¦×¨×™×š ×œ×”×™×•×ª ×›×ª×•×‘ ×‘×—×¨×•×–×™× ×§×œ×™×˜×™× ×”××ª××™××™× ×œ×× ×’×™× ×” ××•×›×¨×ª (×¨×¦×•×™ ×§×¦×‘×™×ª ×•×—×’×™×’×™×ª). ×¢× ×” ×¨×§ ×¢× ××™×œ×•×ª ×”×©×™×¨, ×›×•×œ×œ ×›×•×ª×¨×•×ª '×‘×™×ª 1', '×¤×–××•×Ÿ', ×•×›×•'.";
            
            const userPrompt = `××™×œ×•×ª ×”××¤×ª×— ×©×¦×¨×™×š ×œ×©×œ×‘ ×‘×©×™×¨ ×œ×™××™×¨: ${keywords}. ×”××™×¨×•×¢ ×”×•× ×‘×¨ ××¦×•×•×”/×™×•× ×”×•×œ×“×ª.`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                config: {
                    // Give more tokens for a full song structure
                    maxOutputTokens: 400
                }
            };
            
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "×©×’×™××”: ×œ× ×”×¦×œ×—×ª×™ ×œ×™×™×¦×¨ ×©×™×¨. × ×¡×” ×©×•×‘.";
                return text;

            } catch (error) {
                console.error("Gemini API Song Error:", error);
                return `×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×‘×™× ×” ×”××œ××›×•×ª×™×ª: ${error.message}. × ×¡×” ×©×•×‘.`;
            }
        };

        /**
         * Generates a "prophecy" about Yair's life at age 39.
         */
        window.generateTimeMachineProphecy = async (details) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const systemPrompt = "××ª×” ××¡×˜×¨×•×œ×•×’, ×™×•×¢×¥ ×¢×ª×™×“ ×•×¡×•×¤×¨ ××“×¢ ×‘×“×™×•× ×™. ××©×™××ª×š ×”×™× ×œ×›×ª×•×‘ '× ×‘×•××”' ××• '×—×–×•×Ÿ' ××¤×•×¨×˜ ×¢×œ ×—×™×™×• ×©×œ ×™××™×¨ ×‘×™×•× ×”×•×œ×“×ª×• ×”-39, ×‘×”×ª×‘×¡×¡ ×¢×œ ×”×¤×¨×˜×™× ×”× ×•×›×—×™×™× ×©×”×•× ××¡×¨. ×”× ×‘×•××” ×¦×¨×™×›×” ×œ×”×™×•×ª ××•×¤×˜×™××™×ª, ×™×¦×™×¨×ª×™×ª ×•××“×•×™×§×ª ×›×›×œ ×”××¤×©×¨ ×œ××•×¨ ×”× ×ª×•× ×™×. ×›×ª×•×‘ ×‘×˜×•×Ÿ ××¡×ª×•×¨×™, ×—× ×•××¢×•×¨×¨ ×”×©×¨××”, ×œ×œ× ×›×•×ª×¨×•×ª × ×•×¡×¤×•×ª ××œ×‘×“ ×”× ×‘×•××” ×¢×¦××”.";

            const userPrompt = `×›×ª×•×‘ × ×‘×•××” ×¢×œ ×™××™×¨ ×‘×Ÿ ×”-39. ×”×¤×¨×˜×™× ×”× ×•×›×—×™×™×, ×”×—×œ×•××•×ª ×•×”×©××™×¤×•×ª ×©×œ×• ×”×: ${details}. ×”× ×‘×•××” ×¦×¨×™×›×” ×œ×›×¡×•×ª × ×•×©××™× ×›××• ×§×¨×™×™×¨×”, ××©×¤×—×”, ×ª×—×‘×™×‘×™× ×•×”×™×©×’×™× ×’×“×•×œ×™×.`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                config: {
                    maxOutputTokens: 500 // Give plenty of room for a detailed vision
                }
            };
            
            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "×©×’×™××”: ×œ× ×”×¦×œ×—×ª×™ ×œ×™×™×¦×¨ × ×‘×•××”. × ×¡×” ×©×•×‘.";
                return text;

            } catch (error) {
                console.error("Gemini API Time Machine Error:", error);
                return `×©×’×™××” ×‘×—×™×‘×•×¨ ×œ×‘×™× ×” ×”××œ××›×•×ª×™×ª: ${error.message}. × ×¡×” ×©×•×‘.`;
            }
        };


        /**
         * Generates an image from a prompt using Imagen. (Dream Machine)
         * @param {string} prompt - The image prompt (memory description).
         * @returns {Promise<string>} - Base64 data URL of the image.
         */
        window.generateAiImage = async (prompt) => {
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;
            
            // Adjust prompt for a more celebratory or nostalgic look
            const fullPrompt = `Create a detailed, high-quality, and evocative artistic image representing the following personal memory, dream, or wish. Use a cinematic and nostalgic style. Description: "${prompt}"`;
            
            const payload = {
                instances: [{ prompt: fullPrompt }],
                parameters: {
                    "sampleCount": 1,
                    "aspectRatio": "1:1" 
                }
            };

            try {
                const response = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                    return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                } else {
                    console.error("Imagen API Error:", result);
                    return null;
                }
            } catch (error) {
                console.error("Imagen API Error:", error);
                return null;
            }
        };


        // --- FIREBASE DATA MANAGEMENT (GREETINGS WALL) ---
        
        /**
         * Sets up the real-time listener for the greetings wall.
         */
        const setupGreetingListener = () => {
            const greetingsRef = getGreetingsCollectionRef();
            const greetingsListElement = document.getElementById('greetings-list');

            onSnapshot(greetingsRef, (snapshot) => {
                const greetings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    greetings.push({
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
                    });
                });
                
                // Sort by timestamp (newest first)
                greetings.sort((a, b) => b.timestamp - a.timestamp);
                
                renderGreetings(greetings, greetingsListElement);
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                // FIX: Check for permission error and give explicit instructions to the user.
                if (error.code === 'permission-denied' || error.message.includes('permissions')) {
                     greetingsListElement.innerHTML = `<div class="text-red-600 text-center p-4">×©×’×™××” ×‘××‘×˜×—×ª × ×ª×•× ×™×: ×—×¡×¨×•×ª ×”×¨×©××•×ª ×§×¨×™××” ×‘-Firestore. ×× × ×¢×“×›×Ÿ/×™ ××ª ×›×œ×œ×™ ×”××‘×˜×—×” (Security Rules) ×‘×¤×¨×•×™×§×˜ Firebase ×©×œ×š ×›×“×™ ×œ××¤×©×¨ ×§×¨×™××” ×œ× ×ª×™×‘ ×”×¦×™×‘×•×¨×™.</div>`;
                     console.error("ACTION REQUIRED: Firebase Security Rules must be updated! The rule 'allow read, write: if request.auth != null;' must be set for the public greetings path.");
                } else {
                     greetingsListElement.innerHTML = `<div class="text-red-600 text-center p-4">×©×’×™××” ×‘×˜×¢×™× ×ª ×”×‘×¨×›×•×ª: ${error.message}</div>`;
                }
            });
        };

        /**
         * Renders the list of greetings and responses.
         * @param {Array<Object>} greetings - Array of greeting objects.
         * @param {HTMLElement} container - The DOM element to render into.
         */
        const renderGreetings = (greetings, container) => {
            container.innerHTML = ''; // Clear existing list
            
            if (greetings.length === 0) {
                container.innerHTML = `<div class="text-gray-500 text-center p-8 text-lg">××™×Ÿ ×¢×“×™×™×Ÿ ×‘×¨×›×•×ª ×‘×§×™×¨. ×”×•×¡×£ ××ª ×”×‘×¨×›×” ×”×¨××©×•× ×”!</div>`;
                return;
            }

            greetings.forEach(greeting => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'greeting-item card mb-6 border-2 border-yellow-200';
                
                const timestampStr = greeting.timestamp.toLocaleDateString('he-IL', {
                    year: 'numeric', month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                // Convert comments array to HTML
                const responsesHtml = (greeting.responses || []).map(response => `
                    <div class="bg-yellow-50/50 p-2 rounded-lg mt-2 text-sm border border-yellow-100">
                        <span class="font-bold text-yellow-700 break-words">${response.userId.substring(0, 8)}...</span>: 
                        <span class="break-words">${response.text}</span>
                    </div>
                `).join('');

                itemDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-3 border-b pb-2 border-yellow-200">
                        <div>
                             <h3 class="text-xl font-bold text-gray-800">${greeting.title}</h3>
                             <p class="text-sm text-gray-500">× ×©×œ×— ×¢×œ ×™×“×™: <span class="font-mono">${greeting.userId.substring(0, 8)}...</span></p>
                        </div>
                        <span class="text-xs text-gray-400 mt-1">${timestampStr}</span>
                    </div>
                    
                    <p class="text-gray-700 whitespace-pre-wrap mb-4">${greeting.content}</p>

                    <div class="responses-section mt-4 pt-3 border-t border-gray-100">
                        <h4 class="font-semibold text-gray-600 mb-2">×ª×’×•×‘×•×ª (${(greeting.responses || []).length}):</h4>
                        <div class="responses-list mb-3 max-h-40 overflow-y-auto">${responsesHtml}</div>
                        
                        <form data-greeting-id="${greeting.id}" class="response-form flex mt-3">
                            <input type="text" name="responseText" placeholder="×”×•×¡×£ ×ª×’×•×‘×”..." required 
                                class="flex-grow p-2 border border-gray-300 rounded-r-lg focus:ring-yellow-500 focus:border-yellow-500">
                            <button type="submit" class="bg-yellow-600 text-white p-2 rounded-l-lg hover:bg-yellow-700 transition duration-150">×©×œ×—</button>
                        </form>
                    </div>
                `;
                
                // Add event listener for the response form
                const responseForm = itemDiv.querySelector('.response-form');
                responseForm.addEventListener('submit', handleResponseSubmit);

                container.appendChild(itemDiv);
            });
        };

        /**
         * Handles the submission of a new greeting.
         */
        window.handleNewGreetingSubmit = async (event) => {
            event.preventDefault();
            if (!isAuthReady) {
                showModal('×”××™××•×ª ×¢×“×™×™×Ÿ ×‘×ª×”×œ×™×š, ×× × ×”××ª×Ÿ ×©× ×™×”.');
                return;
            }
            
            const form = event.target;
            const title = form.elements.greetingTitle.value.trim();
            const content = form.elements.greetingContent.value.trim();
            const submitButton = form.querySelector('button[type="submit"]');

            if (!title || !content) return;

            submitButton.disabled = true;
            submitButton.textContent = '×©×•×œ×—...';

            try {
                await addDoc(getGreetingsCollectionRef(), {
                    userId: userId,
                    title: title,
                    content: content,
                    timestamp: new Date(),
                    responses: [] // Initialize an empty array for responses
                });
                
                form.reset();
                showModal('×”×‘×¨×›×” × ×©×œ×—×” ×‘×”×¦×œ×—×” ×œ×§×™×¨!');

            } catch (error) {
                console.error("Error adding greeting:", error);
                showModal('×©×’×™××” ×‘×©×œ×™×—×ª ×”×‘×¨×›×”. × ×¡×” ×©×•×‘.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = '×”×•×¡×£ ×‘×¨×›×” ×œ×§×™×¨';
            }
        };

        /**
         * Handles the submission of a response to a greeting.
         */
        const handleResponseSubmit = async (event) => {
            event.preventDefault();
            if (!isAuthReady) {
                showModal('×”××™××•×ª ×¢×“×™×™×Ÿ ×‘×ª×”×œ×™×š, ×× × ×”××ª×Ÿ ×©× ×™×”.');
                return;
            }

            const form = event.target;
            const greetingId = form.getAttribute('data-greeting-id');
            const responseText = form.elements.responseText.value.trim();
            const submitButton = form.querySelector('button[type="submit"]');

            if (!responseText) return;

            submitButton.disabled = true;
            const originalText = submitButton.textContent;
            submitButton.textContent = '...';

            try {
                const greetingRef = doc(getGreetingsCollectionRef(), greetingId);
                
                const newResponse = {
                    userId: userId,
                    text: responseText,
                    timestamp: new Date().toISOString()
                };

                // Atomically update the document by adding the new response to the array
                await updateDoc(greetingRef, {
                    responses: arrayUnion(newResponse)
                });
                
                form.reset();
            } catch (error) {
                console.error("Error adding response:", error);
                showModal('×©×’×™××” ×‘×©×œ×™×—×ª ×”×ª×’×•×‘×”. × ×¡×” ×©×•×‘.');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = originalText;
            }
        };


        // --- UI LOGIC ---

        window.onload = () => {
            const generateForm = document.getElementById('generate-greeting-form');
            generateForm.addEventListener('submit', handleGenerateGreeting);

            const dreamForm = document.getElementById('dream-machine-form');
            dreamForm.addEventListener('submit', handleDreamMachine);
            
            const songForm = document.getElementById('generate-song-form');
            songForm.addEventListener('submit', handleGenerateSong);
            
            // NEW: Time Machine Event Listener
            const timeMachineForm = document.getElementById('time-machine-form');
            timeMachineForm.addEventListener('submit', handleTimeMachine);


            // Initial tab setup
            window.changeTab('generator');
        };

        window.changeTab = (tabId) => {
            // Hide all contents and deactivate all buttons
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));

            // Show the selected content and activate the button
            document.getElementById(`${tabId}-content`).classList.remove('hidden');
            document.getElementById(`${tabId}-button`).classList.add('active');
        };

        /**
         * Handles the form submission for AI greeting generation.
         */
        const handleGenerateGreeting = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const recipient = form.elements.recipient.value.trim();
            const occasion = form.elements.occasion.value.trim();
            const tone = form.elements.tone.value.trim();
            const sender = form.elements.senderName.value.trim(); 
            const outputArea = document.getElementById('greeting-output');
            const submitButton = form.querySelector('button[type="submit"]');

            if (!recipient || !occasion || !tone) {
                outputArea.innerHTML = '<p class="text-red-500">× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª ×—×•×¥ ××©× ×”×©×•×œ×— (×©××•×ª×• ××¤×©×¨ ×œ×”×©××™×¨ ×¨×™×§).</p>';
                return;
            }

            outputArea.innerHTML = `<div class="loading-ring my-8"></div><p class="text-center text-gray-600 mt-4">×”-AI ×›×•×ª×‘ ××ª ×”×‘×¨×›×”...</p>`;
            submitButton.disabled = true;

            const prompt = `×›×ª×•×‘ ×‘×¨×›×” ×œ××“× ×‘×©×: ${recipient}, ×œ×¨×’×œ ×”××™×¨×•×¢: ${occasion}. ×”×˜×•×Ÿ ×”×¨×¦×•×™ ×”×•×: ${tone}.`;

            try {
                const greetingText = await generateAiGreeting(prompt);
                
                // Append sender name to the generated text for display and posting
                const finalGreetingText = sender 
                    ? `${greetingText}\n\n×‘××”×‘×” ×¨×‘×”,\n${sender}` 
                    : greetingText;
                
                // Create a dynamic title for posting to the wall
                const postTitle = sender 
                    ? `×‘×¨×›×” ×—×’×™×’×™×ª ×-${sender} ×œ×™××™×¨ (${occasion})` 
                    : `×‘×¨×›×” ×œ×™××™×¨ (${occasion})`;

                outputArea.innerHTML = `<div class="card bg-gray-50 border border-gray-200 p-6 ai-output text-right">${finalGreetingText}</div>
                                        <button onclick="copyToClipboard(document.querySelector('#greeting-output .ai-output').innerText)" 
                                            class="mt-4 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 w-full md:w-auto">×”×¢×ª×§ ×‘×¨×›×”</button>`;
                
                // Set the generated text into the "Post to Wall" section for easy sharing
                document.getElementById('post-title').value = postTitle; 
                document.getElementById('post-content').value = finalGreetingText;

            } catch (error) {
                outputArea.innerHTML = `<p class="text-red-500 mt-4">×©×’×™××”: ×œ× × ×™×ª×Ÿ ×”×™×” ×œ×™×¦×•×¨ ××ª ×”×‘×¨×›×”. ×× × ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×©×œ×š.</p>`;
            } finally {
                submitButton.disabled = false;
            }
        };

        /**
         * Handles the form submission for AI song generation.
         */
        const handleGenerateSong = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const keywords = form.elements.songKeywords.value.trim();
            const sender = form.elements.senderName.value.trim();
            const outputArea = document.getElementById('song-output');
            const submitButton = form.querySelector('button[type="submit"]');

            if (!keywords) {
                outputArea.innerHTML = '<p class="text-red-500">× × ×œ×¡×¤×§ ××™×œ×•×ª ××¤×ª×— ××• ×–×™×›×¨×•× ×•×ª.</p>';
                return;
            }

            outputArea.innerHTML = `<div class="loading-ring my-8"></div><p class="text-center text-gray-600 mt-4">×”-AI ×›×•×ª×‘ ××ª ×”×©×™×¨ ×œ×™××™×¨...</p>`;
            submitButton.disabled = true;

            try {
                const songLyrics = await generateAiSong(keywords);
                
                // Append sender name to the generated text for display and posting
                const finalSongText = sender 
                    ? `${songLyrics}\n\n××•×§×“×© ×‘××”×‘×” ×-${sender}.` 
                    : songLyrics;
                
                // Create a dynamic title for posting to the wall
                const postTitle = sender 
                    ? `×©×™×¨ ××™×©×™ ×œ×™××™×¨ ×-${sender}!` 
                    : `×©×™×¨ ××™×©×™ ×œ×™××™×¨!`;


                outputArea.innerHTML = `<div class="card bg-yellow-50 border border-yellow-200 p-6 ai-output">${finalSongText}</div>
                                        <button onclick="copyToClipboard(document.querySelector('#song-output .ai-output').innerText)" 
                                            class="mt-4 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 w-full md:w-auto">×”×¢×ª×§ ×©×™×¨</button>`;
                
                // Optional: Pre-fill post to wall section
                document.getElementById('post-title').value = postTitle;
                document.getElementById('post-content').value = finalSongText;


            } catch (error) {
                outputArea.innerHTML = `<p class="text-red-500 mt-4">×©×’×™××”: ×œ× × ×™×ª×Ÿ ×”×™×” ×œ×™×¦×•×¨ ××ª ×”×©×™×¨. ×× × × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</p>`;
            } finally {
                submitButton.disabled = false;
            }
        };
        
        /**
         * Handles the form submission for Time Machine (Prophecy Generation).
         */
        const handleTimeMachine = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const details = form.elements.timeMachineDetails.value.trim();
            const outputArea = document.getElementById('prophecy-output');
            const submitButton = form.querySelector('button[type="submit"]');

            if (!details) {
                outputArea.innerHTML = '<p class="text-red-500">× × ×œ×ª××¨ ××ª ×”×¤×¨×˜×™× ×•×”×©××™×¤×•×ª ×”× ×•×›×—×™×•×ª ×©×œ ×™××™×¨.</p>';
                return;
            }

            outputArea.innerHTML = `<div class="loading-ring my-8"></div><p class="text-center text-gray-600 mt-4">ğŸ”® ××›×•× ×ª ×”×–××Ÿ ×˜×•×¢× ×ª ××ª ×”×—×–×•×Ÿ ×©×œ ×™××™×¨ ×‘×Ÿ ×”-39...</p>`;
            submitButton.disabled = true;

            try {
                const prophecyText = await generateTimeMachineProphecy(details);
                
                const finalProphecyText = `--- × ×‘×•××” ×œ×™×•× ×”×•×œ×“×ª 39 ---\n\n${prophecyText}\n\n--- ×”××¡×¢ ×¨×§ ×”×—×œ ---`;
                
                const postTitle = `ğŸ”® × ×‘×•××ª ×”×¢×ª×™×“: ×™××™×¨ ×‘×Ÿ ×”-39`;

                outputArea.innerHTML = `<div class="card bg-indigo-50 border border-indigo-200 p-6 ai-output text-right font-serif text-lg">${finalProphecyText}</div>
                                        <button onclick="copyToClipboard(document.querySelector('#prophecy-output .ai-output').innerText)" 
                                            class="mt-4 bg-green-500 text-white p-2 rounded-lg hover:bg-green-600 transition duration-150 w-full md:w-auto">×”×¢×ª×§ × ×‘×•××”</button>`;
                
                // Optional: Pre-fill post to wall section
                document.getElementById('post-title').value = postTitle;
                document.getElementById('post-content').value = finalProphecyText;


            } catch (error) {
                outputArea.innerHTML = `<p class="text-red-500 mt-4">×©×’×™××”: ×œ× × ×™×ª×Ÿ ×”×™×” ×œ×—×–×•×ª ××ª ×”×¢×ª×™×“. ×× × × ×¡×” ×©×•×‘.</p>`;
            } finally {
                submitButton.disabled = false;
            }
        };


        /**
         * Handles the form submission for Dream Machine (Image Generation).
         */
        const handleDreamMachine = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const memoryPrompt = form.elements.memoryPrompt.value.trim();
            const outputArea = document.getElementById('dream-output');
            const submitButton = form.querySelector('button[type="submit"]');

            if (!memoryPrompt) {
                outputArea.innerHTML = '<p class="text-red-500">× × ×œ×ª××¨ ××ª ×”×–×™×›×¨×•×Ÿ ××• ×”×—×œ×•× ×©×œ×š.</p>';
                return;
            }

            outputArea.innerHTML = `<div class="loading-ring my-8"></div><p class="text-center text-gray-600 mt-4">××›×•× ×ª ×”×—×œ×•××•×ª ×™×•×¦×¨×ª ××ª ×”×ª××•× ×”...</p>`;
            submitButton.disabled = true;

            try {
                const imageUrl = await generateAiImage(memoryPrompt);

                if (imageUrl) {
                    outputArea.innerHTML = `
                        <img src="${imageUrl}" alt="×ª××•× ×” ×©× ×•×¦×¨×” ××–×™×›×¨×•×Ÿ: ${memoryPrompt}" 
                            class="rounded-xl w-full max-w-md mx-auto object-cover border-4 border-white shadow-xl">
                        <p class="text-center text-gray-600 mt-4 text-sm">×™×¦×™×¨×ª ×—×œ×•× ×©× ×•×¦×¨×” ×‘×”×¦×œ×—×”.</p>
                    `;
                } else {
                    outputArea.innerHTML = '<p class="text-red-500 mt-4">×©×’×™××”: ×œ× × ×™×ª×Ÿ ×”×™×” ×œ×™×¦×•×¨ ×ª××•× ×” ××”×–×™×›×¨×•×Ÿ. × ×¡×” ×œ×ª××¨ ×‘×¦×•×¨×” ×‘×¨×•×¨×” ×™×•×ª×¨.</p>';
                }
            } catch (error) {
                 outputArea.innerHTML = `<p class="text-red-500 mt-4">×©×’×™××” ×‘×—×™×‘×•×¨ ×œ××›×•× ×ª ×”×—×œ×•××•×ª. × ×¡×” ×©×•×‘ ×××•×—×¨ ×™×•×ª×¨.</p>`;
            } finally {
                submitButton.disabled = false;
            }
        };

        /**
         * Generic function to show a modal message (replaces alert()).
         */
        const showModal = (message) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 3000); // Auto-hide after 3 seconds
        };

        /**
         * Helper function to copy text to clipboard.
         */
        window.copyToClipboard = (text) => {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showModal('×”×‘×¨×›×” ×”×•×¢×ª×§×” ×œ×œ×•×—.');
            } catch (err) {
                console.error('Could not copy text: ', err);
                showModal('×©×’×™××” ×‘×”×¢×ª×§×”. × ×¡×” ×œ×”×¢×ª×™×§ ×™×“× ×™×ª.');
            }
            document.body.removeChild(textarea);
        };
    </script>
</head>

<body class="p-4 md:p-8 min-h-screen">
    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-extrabold text-yellow-700 mb-2">ğŸ‰ ××¡×™×‘×ª ×”×‘×¨×›×•×ª ×©×œ ×™××™×¨ ğŸ‰</h1>
            <p class="text-gray-600 text-lg">×™×•× ×”×•×œ×“×ª ×©××—! ××• ××–×œ ×˜×•×‘ ×œ×‘×¨ ×”××¦×•×•×”! ×›×œ×™ AI ×œ×™×¦×™×¨×” ×•×©×™×ª×•×£.</p>
        </header>

        <!-- User ID Display -->
        <div id="user-id-display" class="text-center text-xs text-gray-400 mb-6 font-mono break-words">××–×”×” ××©×ª××©: ×˜×•×¢×Ÿ...</div>

        <!-- Tab Navigation -->
        <nav class="flex justify-around bg-white p-2 rounded-t-xl shadow-md mb-6 border-b-4 border-yellow-300 overflow-x-auto">
            <button id="generator-button" onclick="changeTab('generator')" class="tab-button text-gray-600 hover:text-yellow-500 px-4 whitespace-nowrap">
                ğŸ“ ××—×•×œ×œ ×‘×¨×›×•×ª AI
            </button>
            <button id="song-button" onclick="changeTab('song')" class="tab-button text-gray-600 hover:text-yellow-500 px-4 whitespace-nowrap">
                ğŸ¶ ××—×•×œ×œ ×©×™×¨×™×
            </button>
            <button id="time-machine-button" onclick="changeTab('time-machine')" class="tab-button text-gray-600 hover:text-yellow-500 px-4 whitespace-nowrap">
                ğŸ”® ××›×•× ×ª ×”×–××Ÿ
            </button>
            <button id="wall-button" onclick="changeTab('wall')" class="tab-button text-gray-600 hover:text-yellow-500 px-4 whitespace-nowrap">
                ğŸ’¬ ×§×™×¨ ×”×‘×¨×›×•×ª
            </button>
            <button id="dream-button" onclick="changeTab('dream')" class="tab-button text-gray-600 hover:text-yellow-500 px-4 whitespace-nowrap">
                âœ¨ ××›×•× ×ª ×—×œ×•××•×ª
            </button>
        </nav>

        <!-- Tab Contents -->
        <div id="app-container" class="bg-white rounded-b-xl p-6 md:p-8 shadow-xl">

            <!-- 1. AI Greeting Generator Content -->
            <div id="generator-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-yellow-700 mb-6">×™×¦×™×¨×ª ×‘×¨×›×” ×œ×™××™×¨ ×‘×××¦×¢×•×ª AI</h2>
                
                <form id="generate-greeting-form" class="space-y-4">
                    <div>
                        <label for="recipient" class="block text-sm font-medium text-gray-700">×œ××™ ×”×‘×¨×›×” ××™×•×¢×“×ª?</label>
                        <input type="text" id="recipient" name="recipient" required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500" 
                            placeholder="×“×•×’××”: ×™××™×¨, ××• ××—×™ ×”×™×§×¨ ×™××™×¨">
                    </div>
                    <div>
                        <label for="occasion" class="block text-sm font-medium text-gray-700">××”×™ ×¡×™×‘×ª ×”×‘×¨×›×”?</label>
                        <input type="text" id="occasion" name="occasion" required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500"
                            placeholder="×“×•×’××”: ×‘×¨ ××¦×•×•×”, ×™×•× ×”×•×œ×“×ª 13, ×™×•× ×”×•×œ×“×ª 16">
                    </div>
                    <div>
                        <label for="tone" class="block text-sm font-medium text-gray-700">××” ×”×˜×•×Ÿ ×”×¨×¦×•×™?</label>
                        <input type="text" id="tone" name="tone" required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500"
                            placeholder="×“×•×’××”: ××¨×’×© ×•××¦×—×™×§, ×¨×¦×™× ×™ ×•×‘×•×’×¨, ×××—×œ ×”×¦×œ×—×” ×‘×œ×™××•×“×™×">
                    </div>
                    <div>
                        <label for="sender" class="block text-sm font-medium text-gray-700">××™ ×©×•×œ×— ××ª ×”×‘×¨×›×”? (×©×)</label>
                        <input type="text" id="sender" name="senderName"
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500" 
                            placeholder="×“×•×’××”: ×“×•×“×” ×¨×•×ª×™, ××• ×—×‘×¨×š ×”×˜×•×‘ ×“× ×™">
                    </div>
                    
                    <button type="submit" class="w-full bg-yellow-600 text-white font-bold py-3 rounded-lg hover:bg-yellow-700 transition duration-150 shadow-md">
                        ×¦×•×¨ ×‘×¨×›×” ×—×’×™×’×™×ª!
                    </button>
                </form>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">×ª×•×¦××•×ª AI:</h3>
                    <div id="greeting-output" class="min-h-24 bg-gray-100 p-4 rounded-lg text-gray-700 text-right">
                        ×›××Ÿ ×ª×•×¤×™×¢ ×”×‘×¨×›×” ×©× ×•×¦×¨×”.
                    </div>
                </div>

                <!-- Section to post the generated greeting to the wall -->
                <div class="mt-10 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">×¤×¨×¡×•× ×”×‘×¨×›×” ×œ×§×™×¨ ×”×‘×¨×›×•×ª ×©×œ ×™××™×¨</h3>
                    <form onsubmit="handleNewGreetingSubmit(event)" class="space-y-3">
                        <input type="text" id="post-title" name="greetingTitle" placeholder="×›×•×ª×¨×ª ×”×‘×¨×›×” (×›×•×ª×¨×ª)" required
                            class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                        <textarea id="post-content" name="greetingContent" rows="4" placeholder="×ª×•×›×Ÿ ×”×‘×¨×›×” (×™××•×œ× ××•×˜×•××˜×™×ª ××”-AI)" required
                            class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border resize-none"></textarea>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                            ×”×•×¡×£ ×‘×¨×›×” ×œ×§×™×¨
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- 2. Song Generator Content -->
            <div id="song-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-yellow-700 mb-6">ğŸ¶ ××—×•×œ×œ ×©×™×¨ ×‘×¨ ××¦×•×•×” ××™×©×™ ×œ×™××™×¨</h2>
                <p class="mb-4 text-gray-600">×”×›× ×¡/×™ ××™×œ×•×ª ××¤×ª×—, ×ª×›×•× ×•×ª ××•×¤×™, ××• ×–×™×›×¨×•× ×•×ª ×©××ª/×” ×¨×•×¦×” ×©×™×•×¤×™×¢×• ×‘×©×™×¨. ×”-AI ×™×›×ª×•×‘ ×©×™×¨ ×—×¨×•×– ×•××§×¤×™×¥ ×œ×™××™×¨!</p>
                
                <form id="generate-song-form" class="space-y-4">
                    <div>
                        <label for="songKeywords" class="block text-sm font-medium text-gray-700">××™×œ×•×ª ××¤×ª×— (×”×¤×¨×“/×™ ×‘×¤×¡×™×§):</label>
                        <textarea id="songKeywords" name="songKeywords" rows="3" required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500 resize-none" 
                            placeholder="×“×•×’××”: ××•×”×‘ ×¤×™×¦×”, ×©×—×§×Ÿ ×›×“×•×¨×’×œ, ××— × ×××Ÿ, ×—×™×•×š ×ª××™×“."></textarea>
                    </div>
                    <div>
                        <label for="songSender" class="block text-sm font-medium text-gray-700">××™ ×©×•×œ×— ××ª ×”×©×™×¨? (×©×)</label>
                        <input type="text" id="songSender" name="senderName"
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500" 
                            placeholder="×“×•×’××”: ×”×”×•×¨×™× ×”××•×”×‘×™×, ××• ×›×œ ×”××©×¤×—×”">
                    </div>
                    
                    <button type="submit" class="w-full bg-orange-500 text-white font-bold py-3 rounded-lg hover:bg-orange-600 transition duration-150 shadow-md">
                        ×¦×•×¨ ×©×™×¨ ×—×’×™×’×™ ××™×©×™!
                    </button>
                </form>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">××™×œ×•×ª ×”×©×™×¨ ×©× ×•×¦×¨×•:</h3>
                    <div id="song-output" class="min-h-32 bg-gray-100 p-4 rounded-lg text-gray-700">
                        ×›××Ÿ ×™×•×¤×™×¢×• ××™×œ×•×ª ×”×©×™×¨.
                    </div>
                </div>

                <!-- Section to post the generated song to the wall -->
                <div class="mt-10 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">×¤×¨×¡×•× ×”×©×™×¨ ×œ×§×™×¨ ×”×‘×¨×›×•×ª ×©×œ ×™××™×¨</h3>
                    <form onsubmit="handleNewGreetingSubmit(event)" class="space-y-3">
                        <input type="text" id="post-title" name="greetingTitle" placeholder="×›×•×ª×¨×ª ×”×©×™×¨ (×™××•×œ× ××•×˜×•××˜×™×ª)" required
                            class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                        <textarea id="post-content" name="greetingContent" rows="6" placeholder="×ª×•×›×Ÿ ×”×©×™×¨ (×™××•×œ× ××•×˜×•××˜×™×ª ××”-AI)" required
                            class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border resize-none"></textarea>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                            ×”×•×¡×£ ×©×™×¨ ×œ×§×™×¨
                        </button>
                    </form>
                </div>
            </div>
            
            <!-- NEW: 3. Time Machine Content -->
            <div id="time-machine-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-yellow-700 mb-6">ğŸ”® ××›×•× ×ª ×”×–××Ÿ: ×™××™×¨ ×‘×Ÿ ×”-39</h2>
                <p class="mb-4 text-gray-600">×¡×¤×¨/×™ ×¢×œ ×”×ª×—×‘×™×‘×™×, ×”×©××™×¤×•×ª ×•×”×—×œ×•××•×ª ×”× ×•×›×—×™×™× ×©×œ ×™××™×¨ (××• ×©×œ× ×• ×¢×‘×•×¨×•!). ×”-AI ×™×—×–×” ×—×–×•×Ÿ ××¨×ª×§ ×œ×™×•× ×”×•×œ×“×ª×• ×”-39.</p>
                
                <form id="time-machine-form" class="space-y-4">
                    <div>
                        <label for="timeMachineDetails" class="block text-sm font-medium text-gray-700">×ª×›×•× ×•×ª, ×—×œ×•××•×ª ×•×©××™×¤×•×ª ×©×œ ×™××™×¨ ×”×™×•×:</label>
                        <textarea id="timeMachineDetails" name="timeMachineDetails" rows="5" required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500 resize-none" 
                            placeholder="×“×•×’××”: ××•×”×‘ ×ª×›× ×•×ª, ×—×•×œ× ×œ×”×™×•×ª ×™×•×˜×™×•×‘×¨ ××¤×•×¨×¡×, ××¦×—×™×§ ×××•×“, ×©×•××£ ×œ×˜×™×™×œ ×‘×¢×•×œ×, ××•×”×‘ ×—×™×•×ª."></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-purple-600 text-white font-bold py-3 rounded-lg hover:bg-purple-700 transition duration-150 shadow-md">
                        ×”×¨×¥ ×¡×™××•×œ×¦×™×”: ×™××™×¨ ×‘×Ÿ 39!
                    </button>
                </form>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">×—×–×•×Ÿ ×”×¢×ª×™×“:</h3>
                    <div id="prophecy-output" class="min-h-32 bg-gray-100 p-4 rounded-lg text-gray-700">
                        ×›××Ÿ ×ª×•×¤×™×¢ ×”× ×‘×•××” ×”××¨×’×©×ª.
                    </div>
                </div>

                <!-- Section to post the generated prophecy to the wall -->
                <div class="mt-10 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold mb-4 text-gray-800">×¤×¨×¡×•× ×”× ×‘×•××” ×œ×§×™×¨ ×”×‘×¨×›×•×ª ×©×œ ×™××™×¨</h3>
                    <form onsubmit="handleNewGreetingSubmit(event)" class="space-y-3">
                        <!-- post-title and post-content are shared with other generators -->
                        <input type="text" id="post-title" name="greetingTitle" placeholder="×›×•×ª×¨×ª ×”× ×‘×•××” (×™××•×œ× ××•×˜×•××˜×™×ª)" required
                            class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border">
                        <textarea id="post-content" name="greetingContent" rows="6" placeholder="×ª×•×›×Ÿ ×”× ×‘×•××” (×™××•×œ× ××•×˜×•××˜×™×ª ××”-AI)" required
                            class="block w-full rounded-lg border-gray-300 shadow-sm p-3 border resize-none"></textarea>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md">
                            ×”×•×¡×£ × ×‘×•××” ×œ×§×™×¨
                        </button>
                    </form>
                </div>
            </div>


            <!-- 4. Greeting Wall Content -->
            <div id="wall-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-yellow-700 mb-6">ğŸ’¬ ×§×™×¨ ×”×‘×¨×›×•×ª: ××–×œ ×˜×•×‘ ×œ×™××™×¨!</h2>
                <div id="greetings-list">
                    <div class="loading-ring my-8"></div>
                    <p class="text-center text-gray-600 mt-4">×˜×•×¢×Ÿ ×‘×¨×›×•×ª ×‘×–××Ÿ ×××ª...</p>
                </div>
            </div>

            <!-- 5. Dream Machine Content -->
            <div id="dream-content" class="tab-content hidden">
                <h2 class="text-2xl font-bold text-yellow-700 mb-6">âœ¨ ××›×•× ×ª ×—×œ×•××•×ª: ×–×™×›×¨×•×Ÿ ××©×•×ª×£ ×¢× ×™××™×¨ ×œ×ª××•× ×”</h2>
                <p class="mb-4 text-gray-600">×ª××¨/×™ ×–×™×›×¨×•×Ÿ ××©×•×ª×£ ×¢× ×™××™×¨, ×—×œ×•× ×œ×¢×ª×™×“ ××• ×¡×¦× ×” ××”××™×¨×•×¢. ×”-AI ×™×”×¤×•×š ××ª ×”×ª×™××•×¨ ×œ×™×¦×™×¨×ª ××× ×•×ª ×•×™×–×•××œ×™×ª.</p>

                <form id="dream-machine-form" class="space-y-4">
                    <div>
                        <label for="memoryPrompt" class="block text-sm font-medium text-gray-700">×ª×™××•×¨ ×”×–×™×›×¨×•×Ÿ/×”×—×œ×•×:</label>
                        <textarea id="memoryPrompt" name="memoryPrompt" rows="4" required
                            class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border focus:ring-yellow-500 focus:border-yellow-500 resize-none"
                            placeholder="×“×•×’××”: ×©× ×™ ××—×™×, ×™××™×¨ ×•×× ×™, ××©×—×§×™× ×›×“×•×¨×’×œ ×‘×©×“×” ×™×¨×•×§ ×‘×©×§×™×¢×”, ×‘×¡×’× ×•×Ÿ ×¦×™×•×¨ × ×•×¡×˜×œ×’×™."></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                        ×”×¤×¢×œ ××ª ××›×•× ×ª ×”×—×œ×•××•×ª
                    </button>
                </form>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-3 text-gray-800">×”×ª××•× ×” ×©× ×•×¦×¨×”:</h3>
                    <div id="dream-output" class="min-h-72 flex items-center justify-center bg-gray-100 p-4 rounded-lg text-gray-500">
                        ×›××Ÿ ×ª×•×¤×™×¢ ×”×ª××•× ×” ×©× ×•×¦×¨×” ×¢×œ ×™×“×™ ×”×‘×™× ×” ×”××œ××›×•×ª×™×ª.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Modal for Messages (Replaces Alert) -->
    <div id="custom-modal" class="hidden fixed inset-0 z-50 flex items-end justify-center pointer-events-none p-4">
        <div class="bg-black bg-opacity-70 text-white py-3 px-6 rounded-xl shadow-lg transform transition duration-300 ease-out"
             role="alert">
            <span id="modal-message"></span>
        </div>
    </div>
</body>
</html>
